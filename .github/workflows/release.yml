name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: "Tag or branch to release (e.g., v1.0.3)"
        required: false
        default: ""

env:
  CARGO_TERM_COLOR: always

jobs:
  build-release:
    name: Build Release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: materiatrack
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: materiatrack
          - os: macos-13
            target: x86_64-apple-darwin
            artifact_name: materiatrack
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: materiatrack

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Set release version (strip leading v)
        run: |
          REF_NAME="${{ inputs.ref || github.ref_name }}"
          VERSION="${REF_NAME#v}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "REF_NAME=${REF_NAME}" >> "$GITHUB_ENV"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install musl tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Configure musl toolchain env
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          echo "CC=musl-gcc" >> $GITHUB_ENV
          echo "CXX=musl-gcc" >> $GITHUB_ENV
          echo "AR=ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }} 2>/dev/null || true

      - name: Create archive
        run: |
          asset_name="materiatrack-${VERSION}-${{ matrix.target }}"
          mkdir -p dist
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} dist/
          cp README.md LICENSE dist/ 2>/dev/null || true
          cp -r man dist/ 2>/dev/null || true
          cd dist
          tar -czvf "../${asset_name}.tar.gz" *

      - name: Generate checksum
        run: |
          asset_name="materiatrack-${VERSION}-${{ matrix.target }}"
          if command -v sha256sum &> /dev/null; then
            sha256sum "${asset_name}.tar.gz" > "${asset_name}.tar.gz.sha256"
          else
            shasum -a 256 "${asset_name}.tar.gz" > "${asset_name}.tar.gz.sha256"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            materiatrack-*.tar.gz
            materiatrack-*.tar.gz.sha256

  release:
    name: Create Release
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Set ref name
        run: |
          REF_NAME="${{ inputs.ref || github.ref_name }}"
          echo "REF_NAME=${REF_NAME}" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MateriaTrack ${{ env.REF_NAME || github.ref_name }}
          body: |
            ## MateriaTrack ${{ env.REF_NAME || github.ref_name }}

            ðŸ’Ž *"Master your time, master your destiny"*

            ### Installation

            **One-liner install:**
            ```bash
            curl -sSL https://raw.githubusercontent.com/ind4skylivey/matteria-track/main/build/install.sh | bash
            ```

            **From source:**
            ```bash
            cargo install materiatrack
            ```

            ### Available Binaries
            - Linux x86_64 (glibc)
            - Linux x86_64 (musl/static)
            - macOS x86_64
            - macOS ARM64 (Apple Silicon)

            ### Checksums
            SHA256 checksums provided for each binary.

            ### Changelog
            See [CHANGELOG.md](https://github.com/ind4skylivey/matteria-track/blob/main/CHANGELOG.md)
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
